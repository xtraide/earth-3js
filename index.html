<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>Syst√®me solaire</title>
	<script type="importmap">
      {
        "imports": {
          "three": "../build/three.module.js",
          "three/addons/": "./jsm/"
        }
      }
    </script>
	<style>
		body {
			background-color: black;
			margin: 0;
		}
	</style>
</head>

<body>
	<!-- The canvas element where the scene will be rendered -->
	<script type="module">
		// Import required modules from Three.js library
		import * as THREE from "three";
		import { OrbitControls } from "three/addons/controls/OrbitControls.js";
		import * as TWEEN from "https://cdn.skypack.dev/@tweenjs/tween.js";
		import { getFresnelMat } from "./src/getFresnelMat.js";
		import getStarfield from "./src/getStarfield.js";
		import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";

		// Create a texture loader
		const textureLoader = new THREE.TextureLoader();

		// Define the level of detail for the Earth geometry
		const detail = 12;

		// Create an IcosahedronGeometry for the Earth
		const geometry = new THREE.IcosahedronGeometry(1, detail);

		// Calculate the aspect ratio of the window
		let aspect = window.innerWidth / window.innerHeight;
		let insetWidth, insetHeight;

		// Create a scene
		const scene = new THREE.Scene();
		scene.background = new THREE.Color(0x000000);

		// Create a renderer for rendering the scene
		const renderer = new THREE.WebGLRenderer();
		renderer.setSize(window.innerWidth, window.innerHeight);
		document.body.appendChild(renderer.domElement);

		// Create a point light and an ambient light
		const PointLight = new THREE.PointLight(0xffffff);
		PointLight.position.set(0, 10, 0);
		const ambientLight = new THREE.AmbientLight(0xffffff);
		scene.add(PointLight, ambientLight);

		// Create a light helper and a grid helper
		const LightHelper = new THREE.PointLightHelper(PointLight);
		const gridHelper = new THREE.GridHelper(200, 50);
		scene.add(LightHelper, gridHelper);

		// Create a starfield
		const stars = getStarfield({ numStars: 2000 });
		scene.add(stars);

		// Create a group for the Earth
		const earthGroup = new THREE.Group();
		earthGroup.scale.set(1, 1, 1);
		earthGroup.position.set(0, 0, 0);
		scene.add(earthGroup);


		// Create a material for the Earth
		const materialearth = new THREE.MeshPhongMaterial({
			map: textureLoader.load("./textures/earth/earth_10k.jpg"),
			bumpMap: textureLoader.load("./textures/earth/earth_topo_10k.jpg"),
			//bumpMap: textureLoader.load("./textures/earth/earth_ocean_reflectance_10k.jpg"),
			bumpScale: 0.04,

		});

		// Create a mesh for the Earth
		var earth = new THREE.Mesh(geometry, materialearth);
		earthGroup.add(earth);

		// Create clouds for the Earth
		const cloudsMat = new THREE.MeshBasicMaterial({
			map: new THREE.TextureLoader().load("textures/earth/earth_clouds_active2.png"),
			transparent: true,
			opacity: 0.8,
			blending: THREE.AdditiveBlending
		});
		const cloudsMesh = new THREE.Mesh(geometry, cloudsMat);
		cloudsMesh.scale.setScalar(1.006);
		earthGroup.add(cloudsMesh);

		// Create a glow effect for the Earth
		const fresnelMat = getFresnelMat();
		const glowMesh = new THREE.Mesh(geometry, fresnelMat);
		glowMesh.scale.setScalar(1.008);
		earthGroup.add(glowMesh);

		// Create a group for the Moon
		const moonGroup = new THREE.Group();
		moonGroup.position.set(2, 0, 0);
		scene.add(moonGroup);

		// Create the Moon
		const moon = new THREE.Mesh(
			geometry,
			new THREE.MeshPhongMaterial({
				map: textureLoader.load("./textures/earth/moon/moon_4k.jpg"),
				bumpMap: textureLoader.load("./textures/earth/moon/moon_topo_4k.jpg"),
				bumpScale: 0.002,
			})
		);
		moon.scale.setScalar(0.27);
		moonGroup.add(moon);

		// Create a group for the sun
		const sunGroup = new THREE.Group();
		sunGroup.position.set(-119, 0, 0);
		scene.add(sunGroup);


		// Create the Sun
		const sun = new THREE.Mesh(
			geometry,
			new THREE.MeshBasicMaterial({
				map: textureLoader.load("./textures/sun/sun.jpg"),
				specularMap: textureLoader.load("./textures/sun/sun-alpha-2k.jpg"), // Use alphaMap instead of gamaMap


			})
		);
		sun.scale.setScalar(109);
		sunGroup.add(sun);

		// Create a camera
		const camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
		camera.position.z = 2.5;
		camera.position.y = 1;
		camera.position.x = 2;
		camera.lookAt(earthGroup.position.x, earthGroup.position.y, earthGroup.position.z);
		scene.add(camera);

		// Create orbit controls for the camera
		const controls = new OrbitControls(camera, renderer.domElement);
		controls.target.set(0, 0.5, 0);
		controls.update();

		// Define the rotation speed
		var rotation = 0.001;

		// Define the animate function for rendering the scene
		function animate() {
			requestAnimationFrame(animate);
			TWEEN.update();
			const orbitRadius = 5;
			const orbitSpeed = 0.01;
			// Calculate the new position of the Earth
			const x = orbitRadius * Math.cos(orbitSpeed * Date.now());
			const z = orbitRadius * Math.sin(orbitSpeed * Date.now());

			// Update the position of the Earth
			earthGroup.position.set(x, earthGroup.position.y, z);
			earthGroup.rotation.y += rotation;
			renderer.setViewport(0, 0, window.innerWidth, window.innerHeight);
			renderer.render(scene, camera);
			renderer.clearDepth();

			renderer.setScissorTest(true);
			renderer.setScissor(
				window.innerWidth - insetWidth - 16,
				window.innerHeight - insetHeight - 16,
				insetWidth,
				insetHeight
			);
			renderer.setViewport(
				window.innerWidth - insetWidth - 16,
				window.innerHeight - insetHeight - 16,
				insetWidth,
				insetHeight
			);

			renderer.setScissorTest(false);
		}

		// Define the resize function for handling window resize events
		function resize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
		}

		// Add a resize event listener
		window.addEventListener("resize", resize);

		// Call the resize function to initialize the scene size
		resize();

		// Start the animation loop
		animate();
	</script>
</body>

</html>